{% extends "base.html" %}

{% block title %}
    Search results
{% endblock %}

{% block content %}
<div class="row">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            {% with entity = None %}
                {% include 'partials/breadcrumbs.html' %}
            {% endwith %}
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-md">
        <div class="row">
            <div class="col">
                <h2>Search results</h2>
            </div>
        </div>

        <form id="entity-form">
            <div class="row">
                <div class="col-md">
                    <div class="input-group">
                        <input type="text" id="entity-lookup" class="form-control form-control-lg" placeholder="Cook County" value="{{ request.GET.get('name', '') }}" autofocus />
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-button">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="row">
            <div class="col-md collapse mt-3" id="name-warning">
                <div class="alert alert-danger" role="alert">
                  <i class="fas fa-exclamation-circle"></i> Please enter the name of a <strong>Unit, Department, or Person</strong> you'd like to look up.
                </div>
            </div>
          </div>

        <div class="row mb-4 mt-3">
            <div class="col ml-2">
                <strong>Result type:</strong> <a class="btn {% if 'entity_type' in request.GET and 'unit' in request.GET['entity_type'] %}bg-light{% endif %} p-1 rounded" href="{{ request.path }}?entity_type=unit&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="fas fa-building"></i> Unit</a> &nbsp;
                <a class="btn {% if 'entity_type' in request.GET and 'department' in request.GET['entity_type'] %}bg-light{% endif %} p-1" href="{{ request.path }}?entity_type=department&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="far fa-building"></i> Department</a> &nbsp;
                <a class="btn {% if 'entity_type' in request.GET and 'person' in request.GET['entity_type'] %}bg-light{% endif %} p-1" href="{{ request.path }}?entity_type=person&{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="far fa-address-card"></i> Person</a> &nbsp;
                <a class="btn {% if 'entity_type' not in request.GET %}bg-light{% endif %} p-1 rounded" href="{{ request.path }}?{{ request|query_transform(drop_keys=['entity_type', 'page']) }}"><i class="fas fa-globe"></i> All</a> &nbsp;
                {% set drop_keys=request.GET.keys() | reject('in', ['entity_type', 'name']) | list %}
                <a class="p-1 btn {% if drop_keys %}text-danger" href="{{ request.path }}?{{ request|query_transform(drop_keys=drop_keys) }}"{% else %}disabled"{% endif %}><i class="fas fa-times"></i> Clear filters</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                {% if request.GET.entity_type %}
                    {% set requested_entities = request.GET.entity_type.split(',') %}
                {% else %}
                    {% set requested_entities = ['unit', 'department', 'person'] %}
                {% endif %}
                {% for entity_type, entity_facets in facets.items() if entity_type in requested_entities %}
                    {% include 'partials/facets.html' %}
                {% endfor %}
            </div>
            <div class="col-md-8">
                <div class="card search-results">
                    {% if results %}
                        <table class="table">
                            <tbody>
                                {% for result in results %}
                                    <tr>
                                        <td>
                                            {{ loop.index0 + page_obj.start_index() }}.
                                            {% include 'partials/search_result.html' %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="card-body">
                            <h4>Dang! We have no results for your search.</h4>
                            Here’s why: You searched for an employee or government unit or department in Illinois that doesn’t exist or that we don’t yet have data on. Want to know more? See our note below.
                        </div>
                    {% endif %}
                </div>
                {% include 'partials/pagination.html' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<div class="modal" tabindex="-1" role="dialog" id="emailModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <div id="fbf1d375-61ec-433d-943f-8d4e6e3ae35a"><script type="text/javascript" src="https://default.salsalabs.org/api/widget/template/82a20ce0-6591-4a90-a77d-d73599ec9b43/?tId=fbf1d375-61ec-433d-943f-8d4e6e3ae35a" ></script></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ static('js/search.js') }}"></script>
<script src="{{ static('js/email_collection.js') }}"></script>

<script type="text/javascript">
    initSearch({{ request.GET.dict()|safe }});

    $('[id*="facet-toggle"]').click(function toggleClick(e) {
        // On click, content has not yet been expanded, i.e., if aria-expanded
        // is false, the element is about to be expanded, so we need to update
        // the button to collapse accordingly.
        var expanding = $(this).attr('aria-expanded') == 'false';

        var expand_text = '<i class="fa fa-chevron-circle-down" aria-hidden="true"></i> Expand';
        var collapse_text = '<i class="fa fa-chevron-circle-up" aria-hidden="true"></i> Collapse';

        if (expanding) {
            $(this).html(collapse_text);
        } else {
            $(this).html(expand_text);
        }
    });
</script>
{% endblock %}
